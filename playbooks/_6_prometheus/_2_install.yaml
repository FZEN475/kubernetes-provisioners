---
#- name: Add stable chart repo prometheus-community
#  kubernetes.core.helm_repository:
#    name: "{{ item.name }}"
#    repo_url: "{{ item.url }}"
#    repo_state: "present"
#    force_update: true
#  with_items:
#    - {name: "prometheus-community", url: "https://prometheus-community.github.io/helm-charts"}
#    - {name: "grafana", url: "https://grafana.github.io/helm-charts"}
#




#
#- name: Remove CIRDs prometheus
#  kubernetes.core.helm:
#    name: prometheus-cird
#    chart_ref: prometheus-community/prometheus-operator-crds
#    release_namespace: monitoring
#    create_namespace: true
#    wait: true
#    state: absent
#
#- name: Remove prometheus
#  kubernetes.core.helm:
#    name: prometheus
#    state: absent
#    chart_ref: prometheus-community/kube-prometheus-stack
#    release_namespace: monitoring
#    create_namespace: true
#    wait: true
#    values_files:
#      - /tmp/values_kube_state_metrics.yaml
#
#- name: Copy values
#  ansible.builtin.copy:
#    src: '/source/config/_6_prometheus_new/_1_values.yaml'
#    dest: '/tmp/values_prometheus.yaml'
#    mode: "0640"
#
#- name: Install prometheus
#  kubernetes.core.helm:
#    name: prometheus
#    state: present
#    chart_ref: prometheus-community/kube-prometheus-stack
#    release_namespace: monitoring
#    create_namespace: true
#    wait: true
#    values_files:
#      - /tmp/values_prometheus.yaml
#
#- name: ConfigMap grafana-config
#  kubernetes.core.k8s:
#    state: present
#    wait: true
#    definition:
#      apiVersion: v1
#      kind: ConfigMap
#      metadata:
#        name: grafana-datasource
#        namespace: 'monitoring'
#        labels:
#          grafana_datasource: ""
#      data:
#        datasource.yaml: "{{ lookup('ansible.builtin.file', '/source/config/_6_prometheus_new/config/datasource.yaml') }}"
#
- name: Creating tmp_kube_state_metrics_dashboard_json
  ansible.builtin.set_fact:
    tmp_kube_state_metrics_dashboard_json: "{{ lookup('ansible.builtin.file', '/source/config/_6_prometheus_new/config/kube-state-metrics-dashboard.json') | replace('\n','')  }}"

- name: Creating tmp_custom_dashboard_json
  ansible.builtin.set_fact:
    tmp_custom_dashboard_json: "{{ lookup('ansible.builtin.file', '/source/config/_6_prometheus_new/config/custom-dashboard.json') | replace('\n','')  }}"

- name: Creating tmp_loki_dashboard_json
  ansible.builtin.set_fact:
    tmp_loki_dashboard_json: "{{ lookup('ansible.builtin.file', '/source/config/_6_prometheus_new/config/loki-dashboard.json') | replace('\n','')  }}"

- name: ConfigMap grafana-config
  kubernetes.core.k8s:
    state: present
    wait: true
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: grafana-dashboard
        namespace: 'monitoring'
        labels:
          grafana_dashboard: ""
      data:
        dashboard01.json: "{{ tmp_kube_state_metrics_dashboard_json | to_json }}"
        dashboard02.json: "{{ tmp_custom_dashboard_json | to_json }}"
        dashboard03.json: "{{ tmp_loki_dashboard_json | to_json }}"


- name: ConfigMap alertmanager-config
  kubernetes.core.k8s:
    state: present
    wait: true
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: alertmanager-config
        namespace: 'monitoring'
        labels:
          alertmanager_config: ""
      data:
        alertmanager.yml: "{{ lookup('ansible.builtin.file', '/source/config/_6_prometheus_new/config/alertmanager.yml') }}"

#- name: Remove prometheus-adapter
#  kubernetes.core.helm:
#    name: prometheus-adapter
#    chart_ref: prometheus-community/prometheus-adapter
#    release_namespace: monitoring
#    create_namespace: true
#    wait: yes
#    state: absent
#
#- name: Copy values
#  ansible.builtin.copy:
#    src: '/source/config/_6_prometheus_new/_2_values-prometheus-adapter.yaml'
#    dest: '/tmp/values_prometheus_adapter.yaml'
#    mode: "0640"
#
#- name: Install prometheus-adapter
#  kubernetes.core.helm:
#    name: prometheus-adapter
#    chart_ref: prometheus-community/prometheus-adapter
#    release_namespace: monitoring
#    create_namespace: true
#    wait: yes
#    state: present
#    values_files:
#      - /tmp/values_prometheus_adapter.yaml


#- name: Remove loki
#  kubernetes.core.helm:
#    name: loki
#    chart_ref: grafana/loki
#    release_namespace: monitoring
#    create_namespace: true
#    wait: yes
#    state: absent
#
#- name: Copy values
#  ansible.builtin.copy:
#    src: '/source/config/_6_prometheus_new/_3_values_loki.yaml'
#    dest: '/tmp/values_loki.yaml'
#    mode: "0640"
#
#- name: Install loki
#  kubernetes.core.helm:
#    name: loki
#    chart_ref: grafana/loki
#    release_namespace: monitoring
#    create_namespace: true
#    wait: yes
#    state: present
#    values_files:
#      - /tmp/values_loki.yaml


#- name: Remove promtail
#  kubernetes.core.helm:
#    name: promtail
#    chart_ref: grafana/promtail
#    release_namespace: monitoring
#    create_namespace: true
#    wait: yes
#    state: absent
#
#- name: Copy values
#  ansible.builtin.copy:
#    src: '/source/config/_6_prometheus_new/_4_values_promtail.yaml'
#    dest: '/tmp/values_promtail.yaml'
#    mode: "0640"
#
#- name: Install promtail
#  kubernetes.core.helm:
#    name: promtail
#    chart_ref: grafana/promtail
#    release_namespace: monitoring
#    create_namespace: true
#    wait: yes
#    state: present
#    values_files:
#      - /tmp/values_promtail.yaml

- name: ConfigMap alertmanager-config
  kubernetes.core.k8s:
    state: present
    wait: true
    definition:
      apiVersion: monitoring.coreos.com/v1alpha1
      kind: AlertmanagerConfig
      metadata:
        name: telegram-alerts
        namespace: monitoring
        labels:
          alertmanager_config: ""
      spec:
        receivers:
          - name: "telegram-notifications"
            telegramConfigs:
              - bot_token: "7909294571:AAENOMhcAKYjtV8WeoFb2tfG4iJZU3kZ1GM"
                chat_id: "-1002513698810"
                apiURL: "https://api.telegram.org"
                message_thread_id: '2'
                message: !unsafe "üö® Alertmanager üö®\n--\nüî∫ Alertname: {{ .GroupLabels.alertname}}\nüî∫ Severity: {{ .CommonLabels.severity }}\nüìå {{ range .Alerts }}{{ .Annotations.summary }}\n{{ end }}"
#                message: |-
#                  {{ if eq .Status "firing" }}üî¥{{ else }}üü¢{{ end }} [{{ .Status | toUpper }}]
#                  {{ range .Alerts }}
#                  *Alert:* {{ .Labels.alertname }}
#                  *Severity:* {{ .Labels.severity }}
#                  {{ if .Annotations.summary }}*Summary:* {{ .Annotations.summary }}{{ end }}
#                  {{ if .Annotations.description }}*Details:* {{ .Annotations.description }}{{ end }}
#                  {{ end }}
                sendResolved: true
                parseMode: "MarkdownV2"  # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (Markdown/V2)
        route:
          groupBy: ['alertname']
          receiver: "telegram-notifications"
